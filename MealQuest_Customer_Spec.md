# MealQuest 顾客端产品全景需求文档 (Master Customer Spec V1.0)


> **项目名称**：MealQuest (餐餐有戏)
> **核心定义**：一款基于“资产包”逻辑的单页式餐饮应用。
> **交互模型**：物理卡片堆叠 (Card Stack) + 底部常驻支付坞 (Payment Dock)。
> **设计原则**：逻辑优先，视觉降噪，资产实体化。

## 第一章：资产体系与经济模型 (The Asset Ecosystem)

本系统建立在“基础资产（投入）”与“合成资产（产出）”的双层架构之上。

### 1.1 L1 碎银子 (Silver) —— 通用货币
*   **定义**：系统内的基础流通积分，无有效期。
*   **产出机制 (The Stable Stream)**：
    *   **基础消费**：每消费 1 元 = 获得 1 两。
    *   **健康出行**：步数换钱，每 1000 步 = 10 两（每日封顶 200 两）。
    *   **游戏产出**：游戏仅产出分数，结算公式 `分数 / 100 = 碎银`。
    *   **溢出补偿**：当食材碎片达到持有上限时，自动按 `1:10` 转化为碎银（无痛熔断）。
*   **消耗场景**：
    *   **集市采购**：购买缺失的普通/稀有碎片。
    *   **支付抹零**：抵扣订单的小额尾数。
*   **风控上限**：持有上限 99,999 两。达限后不再产出。

### 1.2 L2 储值资金 (Balance) —— 金融基石
*   **定义**：强法律属性的预付金，后台严格区分为双账户。
*   **账户结构**：
    *   **本金账户**：用户充值资金，永久有效，可退款。
    *   **赠送账户**：营销赠送资金，滚动有效（变动顺延 180 天），不可提现。
*   **支付逻辑**：优先扣除赠送金 $\rightarrow$ 不足扣除本金。
*   **退款风控 (Clawback Rule)**：
    *   **公式**：`可退金额 = 剩余本金 - (该笔充值已消费金额中包含的赠送金)`。
    *   **逻辑**：退本金意味着“充赠协议”破裂，需回溯扣除已享受的福利。

### 1.3 L3 入席令 (Orders) —— 核心权益
*   **定义**：由碎片合成的成品兑换券，对应具体菜品。
*   **产出机制**：
    *   **碎片合成**：集齐食谱所需碎片自动生成。
    *   **活动赠送**：首单见面礼、周年庆发放。
*   **消耗场景**：到店核销，全额抵扣对应菜品金额。
*   **生命周期**：生成后 90 天有效，支持好友转赠。

### 1.4 L4 食材碎片 (Fragments) —— 行为诱饵
*   **定义**：合成材料，半成品。
*   **产出机制 (The Lucky Stream)**：
    *   **门槛消费**：满 50 元掉落普通盲盒，满 150 元掉落稀有盲盒。
    *   **步数里程碑**：突破 10,000 / 20,000 步掉落。
    *   **集市购买**：消耗碎银购买。
*   **库存上限**：单类碎片上限 99 个。

## 第二章：界面架构规范 (Interface Architecture)

### 2.1 全局导航策略
*   **无 TabBar**：彻底摒弃底部标签栏，采用“单页应用”架构。
*   **卡片即入口**：所有功能入口收纳于首页的 4 张堆叠卡片中。
*   **常驻入口**：
    *   左上角头像 $\rightarrow$ 个人中心 (Profile)。
    *   右上角铃铛 $\rightarrow$ 消息通知 (Notifications)。

### 2.2 核心交互 A：物理堆叠 (Stack Interaction)
首页由 4 张功能卡片纵向堆叠而成。
*   **折叠态 (Default)**：按 `碎银` -> `储蓄` -> `入席令` -> `碎片` 顺序排列。每张卡片仅露出顶部 75px 高度的“额头”摘要区。
*   **展开态 (Expanded)**：点击任意卡片额头 $\rightarrow$ 主角卡片弹射至顶部 (Top: 100px) 展开。其他卡片自动滑落至屏幕底部 (Top: 700px+) 避让。
*   **归位**：再次点击或点空白处 $\rightarrow$ 归位。

### 2.3 核心交互 B：底部常驻支付坞 (Payment Dock)
*   **定位**：最高优先级入口，仅在首页折叠态显示。
*   **形态**：悬浮于屏幕底部的长条形按钮，视觉隐喻为钱包搭扣。
*   **功能**：[支付/核销]。
*   **交互**：点击唤起 “P1. 双模收银台” 半屏浮层。

## 第三章：卡片功能详述 (Card Specs)

### 卡片 A：碎银子 (积分/流通层)
*   **摘要**：当前持有总量 (如：12,850 两)。
*   **详情页功能**：
    *   [逛集市]：跳转至碎银集市。
    *   [赚银两]：跳转至游戏中心。
    *   [步数兑换]：展示今日步数，点击领取碎银。

### 卡片 B：储蓄资金 (金融/支付层)
*   **摘要**：总可用余额 (如：¥120.00)。
*   **详情页功能**：
    *   **账户透视**：图形化展示“本金”与“赠送”数额。
    *   [充值有礼]：跳转至充值中心。
    *   [账单记录]：查看资金流水。

### 卡片 C：入席令 (权益/核销层)
*   **摘要**：可用券数量 (如：2 张)。
*   **详情页功能**：
    *   **持有列表**：展示菜品名称、编号、有效期、等级（金/银）。
    *   **操作**：点击卡片查看详情/转赠/出示核销码。
    *   **历史记录**：查看已核销或失效券。

### 卡片 D：碎片进度 (任务/合成层)
*   **摘要**：主推食谱进度 (如：3/5)。
*   **详情页功能**：
    *   **研制槽位**：
        *   已拥有：显示实物 + 数量。
        *   缺货：显示“缺”标记 + [去集市] 引导按钮。
    *   **切换食谱**：左右滑动切换目标菜品。
    *   **一键合成**：集齐后触发全屏动效，生成入席令。

## 第四章：次级页面详细规范 (Sub-Pages)

### P1. 双模收银台 (Cashier)
*   **入口**：底部支付坞。
*   **模式 A：扫码买单 (顾客扫商家)**
    *   输入金额 $\rightarrow$ 智能策略引擎自动计算抵扣（入席令 > 赠送金 > 碎银） $\rightarrow$ 确认支付。
*   **模式 B：亮码核销 (商家扫顾客)**
    *   展示动态身份码 + 待核销资产列表（入席令/余额）。
    *   商家扫码后，商家端确认扣款项，顾客端同步显示结果。

### P2. 碎银集市 (Marketplace)
*   **Tab A：采购 (Buy)**
    *   **每日补给**：普通碎片，低价，限购。
    *   **稀缺黑市**：稀有碎片，高价，限量。
*   **Tab B：当铺 (Sell)**
    *   **回收列表**：展示用户背包所有碎片。
    *   **操作**：勾选多余碎片 $\rightarrow$ 按回收价变现为碎银。

### P3. 游戏中心 (Arcade)
*   **核心逻辑**：纯街机模式。
*   **游戏不掉落碎片**，只产出分数。
*   **结算**：`分数 / 100 = 碎银`。

### P4. 充值中心 (Top-up)
*   **透明化设计**：明确展示“充 200 (本金) 送 20 (赠送)”。
*   **强制协议**：用户必须勾选“退款回扣赠送金”条款方可充值。

### P5. 个人中心 (Profile)
*   **勋章墙**：展示已获得成就 (如：吃辣达人)。
*   **资产流水**：每一笔碎银、余额、碎片的进出记录。

### P6. 入席令详情页 (Order Detail)
*   **展示**：3D 卡片翻转（正面画报/反面核销码）。
*   **功能**：[转赠好友]（生成微信卡片）、[出示核销]。

## 第五章：关键业务逻辑算法 (Algorithms)

### 5.1 智能支付策略 (Smart Pay Strategy)
当用户发起支付时，系统按以下优先级自动匹配：
1.  **资产层**：检测订单是否包含可被 [入席令] 全额抵扣的菜品 $\rightarrow$ 优先抵扣。
2.  **资金层**：计算剩余金额 $\rightarrow$ 优先扣除 [赠送余额] $\rightarrow$ 不足扣除 [本金余额]。
3.  **积分层**：计算剩余零头 $\rightarrow$ 若用户开启“碎银抹零”且余额充足 $\rightarrow$ 抵扣零头。

### 5.2 每日预算与底价风控 (Risk Control)
*   **产出端控制 (每日预算)**：
    *   老板设置每日营销预算（如 ¥200）。稀有碎片掉落消耗预算。
    *   **熔断降级**：预算耗尽后，稀有碎片掉落自动替换为 [碎银子]（无成本）。
*   **核销端控制 (绝对底价)**：
    *   老板设置每单最低实收比例（如 60%）。
    *   系统限制碎银子/赠送金的最大抵扣额度，确保 `实收现金 >= 底价`。

## 第六章：技术要求 (Tech Specs)

*   **实时性**：资产数据变动需支持 WebSocket 推送。
*   **本地缓存**：首页卡片摘要需缓存，确保秒开。
*   **离线能力**：亮码核销需支持弱网环境下的 Token 缓存与异步上报。

