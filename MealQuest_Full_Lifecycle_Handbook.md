# MealQuest 全链路执行手册（单文档版）

适用目标：你只看这一份文档，就能从 0 开始理解系统、完成本地/联调测试、推进试点上线、进入运营与盈利阶段。

文档定位：执行手册，不是概念展示。

---

## 1. 先记住这句话

MealQuest 不是点餐系统。  
它是“餐饮私域支付 + 资产化运营系统”，核心是把一次付款变成长期复购关系。

---

## 2. 系统全景（你在操作什么）

1. `MealQuestServer`：后端核心（账本、支付、策略、权限、审计、风控、多租户）。
2. `MealQuestMerchant`：商户原生 App（老板/店长/店员操作端）。
3. `meal-quest-customer`：顾客微信小程序（支付与资产体验端）。

你要做的事情本质上是：
1. 让三端连通。
2. 让老板链路和顾客链路都跑通。
3. 让结果可量化（指标）。
4. 让流程可复制（上线运营）。

---

## 3. 角色与核心流程

## 3.1 老板（商户端）

标准链路：
1. 手机号登录。
2. 引导页。
3. 开店。
4. 特约申请。
5. 进入经营台。
6. 策略提案 -> 确认 -> 生效。
7. 必要时熔断（Kill Switch）。

你要验证的结果：
1. 老板不需要懂技术也能完成开店与活动操作。
2. 策略执行有记录、有审计、可回溯。

## 3.2 顾客（小程序）

标准链路：
1. 进入门店。
2. 查看首页资产。
3. 发起支付。
4. 查看账户中心（流水/发票）。
5. 注销（可选测试）。

你要验证的结果：
1. 顾客路径连续、可解释、不跳错。
2. 支付后账务变化正确。

## 3.3 平台运营者（你）

标准动作：
1. 启动环境。
2. 跑回归。
3. 跑双角色演练。
4. 看核心指标。
5. 复盘并决定下一步。

---

## 4. 商业化认知（怎么盈利）

## 4.1 收入来源

1. 门店订阅费（SaaS 月费）。
2. 增值能力费（高级策略、联盟、自动化运营）。
3. 运营服务费（代运营、增长方案、复盘服务）。
4. 支付相关收益（后续真实网关阶段）。

## 4.2 成本来源

1. 云资源与系统运维。
2. 研发维护。
3. 商家成功与运营团队。
4. 市场拓展。

## 4.3 盈利关键

1. 提升付费商家比例。
2. 提高续费率。
3. 让单店价值提升可证明（复购、客单、核销、ROI）。
4. 控制服务成本（自动化比例提高）。

---

## 5. 当前阶段地图（你现在在哪）

## 阶段 A：产品可用（MVP）

完成标志：双端主链路能跑通，服务端具备权限、审计、风控基本能力。

## 阶段 B：线下联调（LAN）

完成标志：同一 Wi-Fi 下，真机可跑双端全流程。

## 阶段 C：灰度上线

完成标志：小规模门店试运行，具备回滚与告警机制。

## 阶段 D：规模化运营

完成标志：可复制签约与续费，收入增长持续高于成本增长。

---

## 6. 一次性准备（第一次做）

1. 电脑与手机在同一 Wi-Fi。
2. 电脑安装 Node.js 与 npm。
3. Android 真机调试（如需跑商户端真机）已开启 USB 调试。
4. 微信开发者工具安装完成（顾客端小程序）。
5. 仓库路径：`D:\Projects\MealQuest`。

---

## 7. 每天固定执行顺序（可复制）

以下命令都在仓库根目录执行。

### 步骤 1：启动局域网服务端

```powershell
.\scripts\start-server-lan.ps1 -Port 3030
```

你会看到：
1. LAN IP 候选（如 `192.168.31.10`）。
2. 服务监听 `0.0.0.0:3030`。

### 步骤 2：启动商户端（在线模式）

```powershell
.\scripts\start-merchant-app.ps1 -Mode online -Platform android -ServerBaseUrl 'http://192.168.31.10:3030'
```

说明：
1. 会自动注入商户端环境变量。
2. 会自动起 Metro，并执行 debug 安装启动。

### 步骤 3：启动顾客端（在线模式）

```powershell
.\scripts\start-customer-weapp.ps1 -Mode online -ServerBaseUrl 'http://192.168.31.10:3030' -StoreId 'm_my_first_store'
```

### 步骤 4：执行老板 + 顾客双角色验证

按第 10 章“标准验收脚本”逐项跑。

---

## 8. 环境模式（local / online）

## 8.1 local 模式

用途：仅演示 UI 或离线流程，不依赖服务端。

商户端：
```powershell
.\scripts\start-merchant-app.ps1 -Mode local -Platform android
```

顾客端：
```powershell
.\scripts\start-customer-weapp.ps1 -Mode local -StoreId 'm_my_first_store'
```

## 8.2 online 模式

用途：联调真实本地后端 API（推荐日常验证用）。

关键：`ServerBaseUrl` 必须是电脑 LAN IP，不能是 `127.0.0.1`。

---

## 9. 一键门禁（每天至少一次）

```powershell
node .\scripts\release-local.js
```

通过标准：
1. 服务端测试通过。
2. 服务端 smoke 通过。
3. 商户端测试和类型检查通过。
4. 顾客端测试与构建通过。
5. 报告 `artifacts/release-local-report.json` 中 `allPassed=true`。

---

## 10. 标准验收脚本（老板 + 顾客）

## 10.1 老板验收

1. 打开商户 App。
2. 完成手机号登录。
3. 完成开店（自定义门店）。
4. 完成特约申请。
5. 进入经营台。
6. 创建一个策略提案并确认。
7. 手动触发相关事件，观察策略执行。
8. 打开/关闭熔断，确认策略阻断。

通过条件：
1. 全链路无崩溃。
2. 操作有反馈。
3. 审计/事件可追踪。

## 10.2 顾客验收

1. 进入启动页并进入门店。
2. 首页可见资产区与活动区。
3. 完成一次支付。
4. 进入账户中心查看流水/发票。
5. 测试注销二次确认（可选）。

通过条件：
1. `startup -> index -> account` 路径可达。
2. 支付后账务有变化。
3. 本人数据可读，跨用户/跨商户受限。

---

## 11. 关键指标（每天记录）

至少记录这 8 个：
1. 服务可用性（是否有中断）。
2. API 错误率。
3. 支付成功率。
4. 活动触发率。
5. 活动核销率。
6. 复购率（试点门店）。
7. 商户活跃率（本周活跃门店占比）。
8. 严重故障数（P0/P1）。

---

## 12. 常见问题与排查顺序

## 12.1 手机连不上服务端

先查：
1. 是否用了 `127.0.0.1`（错误）。
2. 是否同一 Wi-Fi。
3. 防火墙是否放行 3030 入站。

## 12.2 小程序请求失败

先查：
1. 微信开发者工具是否允许开发态不校验域名/TLS。
2. `TARO_APP_SERVER_BASE_URL` 是否是电脑 LAN IP。

## 12.3 商户端启动失败

先查：
1. `npm start`（Metro）是否正常。
2. `npm run android` 是否有设备连接。
3. 环境变量是否注入成功（脚本输出会显示）。

## 12.4 不确定问题在哪

先跑：
```powershell
node .\scripts\release-local.js
```

再根据失败阶段定位：
1. Server 失败 -> 后端问题。
2. Merchant 失败 -> RN 环境/前端问题。
3. Customer 失败 -> 小程序构建/测试问题。

---

## 13. 上线前最小标准（Go / No-Go）

满足全部才 Go：
1. 连续 7 天关键链路稳定（无 P0）。
2. 至少 1 家试点门店跑出正向经营结果。
3. 有发布、回滚、告警、值班责任人。
4. 隐私/权限/审计检查通过。

任一不满足 -> No-Go，只做补齐，不开新范围。

---

## 14. 30 天执行计划（按周推进）

## 第 1 周：打底

目标：双端 LAN 稳定。

日动作：
1. 每天跑双端主链路 1 次。
2. 每天记录问题与修复。

周产出：
1. 门店开通 SOP。
2. 顾客支付 SOP。
3. 双端联调录屏。

## 第 2 周：试点

目标：真实门店跑数据。

日动作：
1. 每天记录支付成功率/核销率/异常数。
2. 当天问题当天闭环。

周产出：
1. 第 2 周试点复盘。
2. 第一份“经营改善证据”。

## 第 3 周：优化

目标：形成续费证据。

日动作：
1. 仅优化 1~2 个高价值策略。
2. 每天看 ROI。

周产出：
1. 门店前后对比报告（客单/复购/核销）。
2. 行业策略推荐清单。

## 第 4 周：上线准备

目标：进入灰度条件。

日动作：
1. 每天跑门禁。
2. 每天核对灰度准备项。

周产出：
1. 灰度门店名单与时间表。
2. 上线 Go/No-Go 评估结论。

---

## 15. 每周复盘模板（直接复制）

```text
【本周目标】
-

【实际结果】
-

【核心指标】
- 支付成功率：
- 活动核销率：
- 复购率：
- 商家活跃率：
- 系统错误率：

【本周最大问题】
- 现象：
- 根因：
- 修复动作：
- 是否复发：

【商家价值证明】
- 本周给商家带来的量化变化：

【下周优先级（最多3项）】
1.
2.
3.
```

---

## 16. 你每天只需要回答这 3 个问题

1. 今天有没有直接提升稳定性或商家经营结果？
2. 今天做的事能不能量化验证？
3. 今天做的事能不能复制到下一家门店？

三个都是“是”，你就在正确方向上。

---

## 17. 附录：关键命令总表

```powershell
# 1) 启动 LAN 服务器
.\scripts\start-server-lan.ps1 -Port 3030

# 2) 商户端在线模式
.\scripts\start-merchant-app.ps1 -Mode online -Platform android -ServerBaseUrl 'http://<LAN_IP>:3030'

# 3) 顾客端在线模式
.\scripts\start-customer-weapp.ps1 -Mode online -ServerBaseUrl 'http://<LAN_IP>:3030' -StoreId 'm_my_first_store'

# 4) 全量回归门禁
node .\scripts\release-local.js

# 5) 服务端单独测试
cd .\MealQuestServer
npm test
```

---

## 18. 你现在立刻该做什么

1. 按第 7 章命令跑起三端。
2. 按第 10 章跑双角色验收。
3. 按第 11 章开始记录指标。
4. 一周后按第 15 章输出复盘。

完成这 4 步，你就不是“在试系统”，而是在“推进可上线业务”。
