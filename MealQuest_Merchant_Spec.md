# 有戏掌柜 产品全景需求文档 (Master Merchant PRD V3.0)

> **项目名称**：有戏掌柜 (MealQuest Merchant)
> **核心定义**：餐饮老板的移动经营指挥部，与用户端“入席令”资产体系完美对接。
> **交互模型**：中心化 Tab 导航 (Center Tab Navigation)。
> **设计原则**：极简决策，数据可视化，操作傻瓜化，算法严谨。

---

## 一、 核心功能架构 (Functional Architecture)

App 采用底部 5-Tab 结构，确保所有高频功能一触即达：

1.  **经营 (Dashboard)**：实时看板与动态预警 [Tab 1]。
2.  **账单 (Financing)**：流水查询、退款处理与对账 [Tab 2]。
3.  **收银 (Cashier)**：[黄金中心位] 聚合支付与入席令核销 [Tab 3]。
4.  **装修 (Studio)**：品牌视觉与资产元数据配置 [Tab 4]。
5.  **管理 (Admin)**：风控设置、员工权限与店铺基础信息 [Tab 5]。

---

## 二、 页面详细规范 (Page Specifications)

### L0. 注册与登录 (Login & Register) [Pre-Entry]
*   **手机号登录**: 仅支持手机号 + 短信验证码登录/注册。
    *   *逻辑*: 登录即创建/关联 `owner_id`。所有后续进件与门店数据均绑定于此账号。
*   **引导逻辑**:
    *   若该手机号未关联任何门店 $\rightarrow$ 跳转 **[P0 聚合进件]**。
    *   若已关联门店 $\rightarrow$ 跳转 **[P1 经营仪表盘]**。
    *   若处于审核中 $\rightarrow$ 跳转 **[P0 状态页]** (显示审核进度与客服入口)。

### P0. 极速开店 (Quick Start) [Tab 0 - Instant]
*   **定位**：降低门槛，允许老板先体验“营销”与“资产”功能，后补全支付资质。
*   **流程**：
    1.  **手机号登录**。
    2.  **创建门店**：仅需输入 `店铺名称`、`经营品类` 与 `门头照`。
    3.  **即刻可用**：进入 [P1 仪表盘]。此时可正常使用 **[装修]**、**[发券]**、**[游戏配置]** 等营销功能。
    4.  **限制**：
        *   无法生成 **[聚合收款码]**。
        *   无法进行 **[充值/支付]** 交易（收银台仅支持“核销”模式）。

### P0.5 支付进件 (Payment Activation) [Async]
*   **触发点**：当老板点击 [P3 收银台] 的 **"启用收款"** 或 [P0 状态页] 的 **"开通支付"** 时触发。
*   **核心策略**：**一次提交，双通道分发 (One Submission, Dual Channel)**。
    *   商户只需提交一套资料，系统自动分别向 **微信支付 (WeChat Pay)** 与 **支付宝 (Alipay)** 发起进件申请。
*   **交互流程 (The 4-Step Flow)**：
    1.  **资质 OCR (Identity)**：
        *   拍摄营业执照 $\rightarrow$ 系统自动识别通过 `OCR` 填入：商户全称、证件号、注册地址。
        *   拍摄法人身份证 (人像面/国徽面) $\rightarrow$ 自动识别填入：法人姓名、身份证号、有效期。
    2.  **店铺信息 (Shop Info)**：
    2.  **店铺信息 (Shop Info)**：
        *   **LBS 定位**：自动获取当前 GPS，允许微调门店实际位置。
        *   **手动兜底 (Fallback)**：若用户拒绝定位权限或 GPS 信号弱，允许**手动拖拽地图大头针** 或 **输入详细地址** 进行定位校准。
    3.  **商户认证 (Auth)**：
        *   **微信侧**：生成“微信支付商家助手”小程序码 $\rightarrow$ 法人扫码完成人脸核身 $\rightarrow$ 绑定特约商户号。
        *   **支付宝侧**：生成支付宝授权二维码 $\rightarrow$ 法人扫码授权 $\rightarrow$ 绑定间连/直连商户号。
    4.  **签约与费率 (Signing)**：
        *   电子签约确认：微信支付费率 (0.6% / 0.38%)、支付宝费率。
        *   **入驻完成**：状态变更为 `Pending` (审核中)。
    *   `Unverified` (未认证 - 仅营销) $\rightarrow$ `Auditing` (支付审核中) $\rightarrow$ `Active` (全功能解锁)。

### P1. 经营仪表盘 (Business Dashboard) [Tab 1]
*   **定位**：商户入驻审核通过后，首次进入 App 的**必须**流程，确保老板能跑通最小业务闭环。
*   **形式**：覆盖在 P1 仪表盘上的全屏或半屏引导卡片 (Wizard Card)。
*   **任务清单 (Checklist)**：
    1.  **配置首款资产**：引导跳转 [P4 装修]，快速创建一个“招牌菜入席令”（只需上传图片、定名、库存）。
    2.  **邀请首位员工**：引导跳转 [P6 管理 - 员工]，生成邀请码。
    3.  **打印机联调**：(可选) 连接蓝牙打印机并打印一张测试用的“核销凭证”。
*   **奖励**：完成向导后，系统自动赋予店铺 **“新手保护期”** 流量扶持（如：首周碎银/碎片产出无风控降权）。

### P1. 经营仪表盘 (Business Dashboard) [Tab 1]
*   **定位**：老板的“飞行员座舱”，实时监控资产流动。
*   **功能模块**：
    *   **实时营收卡片**：今日实收、今日客单、实收均价。
    *   **资产负债看板 (Asset Liability)**：监控碎银产出、入席令核销数及待兑付资产总量。
    *   **智能策略建议**：基于系统算法给出的经营优化方案。
    *   **活动决策箱 (Campaign Inbox)**：展示由 AI 生成的消息/活动建议。商家在此**一键确认**后，消息才送达用户端首页列表或触发推送。
    *   **待开票提醒**：显示 N 笔待处理的发票申请。
    *   **AI 指令悬浮球 (AI Command Orb)**：
        *   **位置**：屏幕右下角悬浮。
        *   **功能**：长按语音输入或点击输入文字指令（如“明天午市推小龙虾”），触发 **意图交互流 (Proactive Mode)**，AI 将生成相应策略卡片推入决策箱。

### P2. 账单明细与退款 (Transactions & Refund) [Tab 2]
*   **定位**：处理每一笔钱和每一个资产的来龙去脉。
*   **核心逻辑**：
    *   **发票管理**：筛选 `[待开票]` 订单 $\rightarrow$ 查看顾客提交的抬头 $\rightarrow$ 上传 PDF 链接或手动标记 `[已开]`。
    *   **退款算法**：严格执行“Clawback 规则”，自动回溯并扣除已消费的赠送金。
    *   **反核销 (Undo Redemption) [高危]**：
        *   **场景**：服务员误扫入席令，或核销后因缺货无法交付。
        *   **入口**：账单详情页的“最近核销”记录。
        *   **规则**：
            1.  仅限 **5 分钟内** 的核销记录可撤销。
            2.  撤销后，入席令状态由 `USED` 恢复为 `ACTIVE`，立即退回顾客账户。
            3.  **权限**：必须由 **[店长]** 或 **[店主]** 角色输入密码/生物认证确认。普通服务员无权操作。

### P3. 双模收银台 (Cashier) [Tab 3 - Central Focus]
*   **定位**：App 核心功能入口。
*   **操作模式**：
    *   **被扫**：展示收款码供顾客扫描。
    *   **被扫**：展示收款码供顾客扫描。
    *   **主扫 (智能结算模式)**：
        1.  **输入总额**：收银员直接输入单据总金额 (如 ¥35.00)。
        2.  **扫码识别**：扫描顾客会员码。
        3.  **自动抵扣**：系统自动检索顾客账户，锁定最优权益（如：自动核销一张 ¥30 面券）。
        4.  **极速支付**：
            *   若余额充足：直接扣除剩余 ¥5，提示“支付成功”。
            *   若余额不足：发起剩余 ¥5 的微信/支付宝代扣请求。
            *   *核心体验*：**收银员全程无需手动勾选票券**，一切由算法代劳。

### P4. 资产与装修 (Assets & Studio) [Tab 4]
*   **定位**：品牌数字孪生配置中心。
*   **核心原则**：**仅管理“权益”，不管理“库存”**。我们不是 POS，不记录后厨剩了多少只鸭子，只控制“今天要送出多少张券”。
*   **功能**：
    *   **资产注册 (Asset Registry)**:
        *   **定义权益**: 
            *   `资产名称`: (如 "招牌葱油面兑换券")。
            *   `票面价值`: (Display Price, 如 ¥28)。顾客感知价值。
            *   `预估成本` (Cost Price, 如 ¥5.2): **[新增]** 不对顾客展示。用于系统后台计算真实的 ROI 与毛利。
        *   **视觉配置**: 上传图片由 AI 转换为 Isometric 3D 模型。
    *   **发行策略 (Issuance Strategy)**:
        *   **每日限量 (Daily Cap)**: 设置该资产每天最多被合成/掉落多少次 (如：限量 50 份)。
        *   **熔断开关 (Kill Switch)**: 遇到突发缺货，一键**“停发”**。立即停止该资产在所有游戏与集市中的掉落。

### P5. 管理与风控 (Admin & Risk) [Tab 5]
*   **利润防火墙 (Profit Firewall)**：商家核心利润保护中枢。
    - **每日预算熔断**：设定碎银+碎片每日发放总额上限（由老板确认）。
    - **经济模式自动触发**：当预算接近/触达上限，系统自动切换至“经济模式”。掉落概率降低，或大额碎片降级为少量碎银。
    - **AI 动态掉率分配**：根据高峰/闲时、核销进度及毛利盈亏自动微调 [P11 游戏结算] 与 [P04 步数挑战] 的产出曲线。
*   **技术防刷防作弊中心**：
    - **设备唯一性绑定**：单一物理设备每日仅能激活/结算固定数量的账号奖励。
    - **微信步数深度校验**：调用微信密封数据并过滤拟真摇晃频率，阻断模拟器增量。
    - **结算延迟审计**：对 [卓越分数] 产出的高级资产执行后台异步巡检（3s 内确认无脚本逻辑后入库）。
    - **风险名单联动**：触发封禁动作（账号/设备 ID），黑名单资产无法核销。
*   **店铺基础信息**：营业时间、地址等。
*   **员工与权限管理**：详见下方 P6 章节。

### P6. 员工与权限管理 (Staff & Permission) —— [核心增强]
*   **定位**：基于“一一对应”原则的团队协作体系。
*   **核心原则**：**一人一号，一机一档 (One Person, One Account)**。
    *   取消传统 POS 的“交接班”概念。所有操作记录（收银、核销、退款）均自动关联至当前登录的员工账号。
    *   **谁在岗，谁登录**。员工上下班仅需登录/登出 App 即可。

#### P6.1 添加店员业务流 (Add Staff Flow)
系统严禁老板手动录入店员隐私信息，采用**“端到端握手”**机制：
1.  **发起邀请**：老板进入“添加店员”，系统生成一个动态邀请二维码（或 6 位数字临时授权码，有效期 10 分钟）。
    *   *界面提示*：老板端屏幕清晰提示：“请店员先前往 App Store / 应用市场下载 **'有戏掌柜'** App”。
2.  **店员操作**：
    *   店员自行下载并安装 App。
    *   **无需注册**：在登录页点击 **“加入店铺 (Join Store)”**。
    *   **扫码/输码**：扫描老板的二维码或输入 6 位授权码。
3.  **提交申请**：店员确认店铺名称无误后，提交加入申请（需绑定手机号以作为员工 ID，但不创建新店铺）。
4.  **权限分配**：老板端即时弹出通知，点击后进入“权限配置”页，选择该成员的职能（如：收银员）。
5.  **绑定成功**：老板点击“确认绑定”，该店员正式获得相应权限。

#### P6.2 权限分层字典 (Role Matrix)

| 权限点              | 店主 (Owner) | 店长 (Manager) | 收银/服务员 (Staff) | 后厨 (Kitchen) |
| :------------------ | :----------: | :------------: | :-----------------: | :------------: |
| **多店切换 (Switch)**|      √       |       ×        |          ×          |       ×        |
| **实时营收总账**    |      √       |       √        |          ×          |       ×        |
| **退款/反核销操作** |      √       |       ×        |          ×          |       ×        |
| **扫码收款/核销**   |      √       |       √        |          √          |       ×        |
| **修改风控参数**    |      √       |       ×        |          ×          |       ×        |
| **品牌装修/配置**   |      √       |       √        |          ×          |       ×        |
| **每日库存/沽清**   |      √       |       √        |          ×          |       ×        |
| **入席令核销通知**  |  语音+弹窗   |   语音+弹窗    |        弹窗         |   语音+小票    |

#### P6.3 离职处理
*   **一键解绑**：老板可随时取消任何店员的授权，解绑后店员 App 立即登出，无法查看任何历史数据。

### P7. 多店管理 (Multi-Store Management) [New]
*   **适用对象**：拥有多家门店的连锁店主 (Cluster Owner)。
*   **交互入口**：在 [Tab 5 管理] 页面的顶部“我的门店”卡片，点击进入 **[门店管理列表]**。
*   **功能逻辑**：
    *   **门店列表**：展示当前账号下的所有门店（如：`有戏小馆-徐汇店`, `有戏小馆-静安店`）。
    *   **新增门店 (Create New Store)**：
        *   列表底部或导航栏右上角提供 **“新增门店”** 按钮。
        *   点击后跳转至 **[P0 聚合进件]** 流程，复用法人实名信息，仅需重新提交新门店的营业执照与位置信息。
    *   **一键切换**：点击门店名称，App 全局上下文（Dashboard 数据、员工列表、收银台配置）即时切换至该门店视角。
    *   **数据隔离**：各门店的经营数据、库存、员工完全独立。
    *   **全局概览 (All-in-One)**：(Alpha) 提供一个汇总视角的 Dashboard，查看所有门店的总营收。

## 三、 关键业务算法规范 (Business Algorithms)

### 1. 自动对账算法 (Auto-Reconciliation)
系统每日 24:00 自动生成《对账日报》，严格区分三类资金流：
*   **实收现金**：进入老板钱包。
*   **赠送金消耗**：营销成本。
*   **入席令折算成本**：权益兑付成本。

### 2. 支付智能推荐算法
当老板主扫核销时，算法按照 **`过期优先 > 赠送优先 > 碎银抹零`** 的权重推荐最佳扣款方案。

---

## 四、 消息推送与播报策略

*   **实时收款播报**：支持不同角色自定义播报内容（如后厨仅播报入席令兑换的菜名，前台播报金额）。
*   **云端/蓝牙打印 (Printing Protocols)**：
    *   **后厨小票**：支持通过 **58mm/80mm 云端适配器 (HTTP/WebSocket)** 或 **低功耗蓝牙 (BLE 4.0)** 自动打印入席令核销存根。
    *   **协议标准**：采用标准 ESC/POS 指令集，支持 2D 资产名称与核销校验码的排版。
*   **策略建议通知**：当系统自动生成新的营销建议时，向 **店主** 发送待办通知，由其进行决策确认。
*   **资产预警**：当预算触达 **80% 警戒线**时，仅向 **店主** 与 **店长** 发送高优先级推送。


## 五、 安全性要求

*   **设备绑定**：在店员登录时，系统会自动记录设备 ID。
*   **异地警报**：若同一账号在异地设备登录，将触发管理员手机二次验证（2FA），确保资金安全。
