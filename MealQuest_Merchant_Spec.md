# 有戏掌柜 产品全景需求文档 (Master Merchant PRD V3.0)

> **项目名称**：有戏掌柜 (MealQuest Merchant)
> **核心定义**：餐饮老板的移动经营指挥部，与用户端“入席令”资产体系完美对接。
> **交互模型**：中心化 Tab 导航 (Center Tab Navigation)。
> **设计原则**：极简决策，数据可视化，操作傻瓜化，算法严谨。

---

## 一、 核心功能架构 (Functional Architecture)

App 采用底部 5-Tab 结构，确保所有高频功能一触即达：

1.  **经营 (Dashboard)**：实时看板与动态预警 [Tab 1]。
2.  **账单 (Financing)**：流水查询、退款处理与对账 [Tab 2]。
3.  **收银 (Cashier)**：[黄金中心位] 聚合支付与入席令核销 [Tab 3]。
4.  **装修 (Studio)**：品牌视觉与资产元数据配置 [Tab 4]。
5.  **管理 (Admin)**：风控设置、员工权限与店铺基础信息 [Tab 5]。

---

## 二、 页面详细规范 (Page Specifications)

### P1. 经营仪表盘 (Business Dashboard) [Tab 1]
*   **定位**：老板的“飞行员座舱”，实时监控资产流动。
*   **功能模块**：
    *   **实时营收卡片**：今日实收、今日客单、实收均价。
    *   **资产负债看板 (Asset Liability)**：监控碎银产出、入席令核销数及待兑付资产总量。
    *   **智能策略建议**：基于系统算法给出的经营优化方案。
    *   **活动决策箱 (Campaign Inbox)**：展示由 AI 生成的消息/活动建议。商家在此**一键确认**后，消息才送达用户端首页列表或触发推送。

### P2. 账单明细与退款 (Transactions & Refund) [Tab 2]
*   **定位**：处理每一笔钱和每一个资产的来龙去脉。
*   **核心逻辑**：
    *   **退款算法**：严格执行“Clawback 规则”，自动回溯并扣除已消费的赠送金。

### P3. 双模收银台 (Cashier) [Tab 3 - Central Focus]
*   **定位**：App 核心功能入口。
*   **操作模式**：
    *   **被扫**：展示收款码供顾客扫描。
    *   **主扫**：识别顾客码并自动匹配入席令/余额进行抵扣。

### P4. 装修工作室 (Decoration Studio) [Tab 4]
*   **定位**：品牌数字孪生配置中心。
*   **功能**：配置入席令的 3D 模型、合成路径及语义名称。

### P5. 管理与风控 (Admin & Risk) [Tab 5]
*   **利润防火墙 (Profit Firewall)**：商家核心利润保护中枢。
    - **每日预算熔断**：设定碎银+碎片每日发放总额上限（由老板确认）。
    - **经济模式自动触发**：当预算接近/触达上限，系统自动切换至“经济模式”。掉落概率降低，或大额碎片降级为少量碎银。
    - **AI 动态掉率分配**：根据高峰/闲时、核销进度及毛利盈亏自动微调 [P11 游戏结算] 与 [P04 步数挑战] 的产出曲线。
*   **技术防刷防作弊中心**：
    - **设备唯一性绑定**：单一物理设备每日仅能激活/结算固定数量的账号奖励。
    - **微信步数深度校验**：调用微信密封数据并过滤拟真摇晃频率，阻断模拟器增量。
    - **结算延迟审计**：对 [卓越分数] 产出的高级资产执行后台异步巡检（3s 内确认无脚本逻辑后入库）。
    - **风险名单联动**：触发封禁动作（账号/设备 ID），黑名单资产无法核销。
*   **店铺基础信息**：营业时间、地址等。
*   **员工与权限管理**：详见下方 P6 章节。

### P6. 员工与权限管理 (Staff & Permission) —— [核心增强]
*   **定位**：多角色协作与团队管理入口。

#### P6.1 添加店员业务流 (Add Staff Flow)
系统严禁老板手动录入店员隐私信息，采用**“端到端握手”**机制：
1.  **发起邀请**：老板进入“添加店员”，系统生成一个动态邀请二维码（或 6 位数字临时授权码，有效期 10 分钟）。
2.  **扫码申请**：店员使用自己的微信或商户端 App（未绑定状态）扫描该码，提交加入申请。
3.  **权限分配**：老板端即时弹出通知，点击后进入“权限配置”页，选择该成员的职能。
4.  **绑定成功**：老板点击“确认绑定”，该店员正式获得相应权限。

#### P6.2 权限分层字典 (Role Matrix)

| 权限点              | 店主 (Owner) | 店长 (Manager) | 收银/服务员 (Staff) | 后厨 (Kitchen) |
| :------------------ | :----------: | :------------: | :-----------------: | :------------: |
| **实时营收总账**    |      √       |       √        |          ×          |       ×        |
| **退款/反核销操作** |      √       |       ×        |          ×          |       ×        |
| **扫码收款/核销**   |      √       |       √        |          √          |       ×        |
| **修改风控参数**    |      √       |       ×        |          ×          |       ×        |
| **品牌装修/配置**   |      √       |       √        |          ×          |       ×        |
| **入席令核销通知**  |  语音+弹窗   |   语音+弹窗    |        弹窗         |   语音+小票    |

#### P6.3 离职处理
*   **一键解绑**：老板可随时取消任何店员的授权，解绑后店员 App 立即登出，无法查看任何历史数据。

---

## 三、 关键业务算法规范 (Business Algorithms)

### 1. 自动对账算法 (Auto-Reconciliation)
系统每日 24:00 自动生成《对账日报》，严格区分三类资金流：
*   **实收现金**：进入老板钱包。
*   **赠送金消耗**：营销成本。
*   **入席令折算成本**：权益兑付成本。

### 2. 支付智能推荐算法
当老板主扫核销时，算法按照 **`过期优先 > 赠送优先 > 碎银抹零`** 的权重推荐最佳扣款方案。

---

## 四、 消息推送与播报策略

*   **实时收款播报**：支持不同角色自定义播报内容（如后厨仅播报入席令兑换的菜名，前台播报金额）。
*   **云端/蓝牙打印 (Printing Protocols)**：
    *   **后厨小票**：支持通过 **58mm/80mm 云端适配器 (HTTP/WebSocket)** 或 **低功耗蓝牙 (BLE 4.0)** 自动打印入席令核销存根。
    *   **协议标准**：采用标准 ESC/POS 指令集，支持 2D 资产名称与核销校验码的排版。
*   **策略建议通知**：当系统自动生成新的营销建议时，向 **店主** 发送待办通知，由其进行决策确认。
*   **资产预警**：当预算触达 **80% 警戒线**时，仅向 **店主** 与 **店长** 发送高优先级推送。


## 六、 安全性要求

*   **设备绑定**：在店员登录时，系统会自动记录设备 ID。
*   **异地警报**：若同一账号在异地设备登录，将触发管理员手机二次验证（2FA），确保资金安全。
