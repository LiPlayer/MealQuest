# 有戏掌柜 - 商户端产品与工程规范 (Master-Aligned V2.0)

> 依据：`MealQuest_Spec.md`（唯一标准）
> 目标：落实“老板定战略，AI 定战术”，让商户在移动端完成策略确认、收银执行、风控熔断。

---

## 1. 规范边界（与总规范强一致）

1. 商户端是经营主控台，不承担复杂 ERP/进销存。
2. AI 仅可提案，不可越权执行；策略必须商户确认。
3. 所有营销策略必须受预算上限与熔断开关约束。
4. 商户端收银必须可解释“抵扣如何发生”。

---

## 2. 商户端模块

## 2.1 驾驶舱（Dashboard）

1. 预算使用：`budgetUsed / budgetCap`。
2. 熔断状态：`killSwitchEnabled`。
3. 待办策略数：来自决策收件箱。

## 2.2 决策收件箱（Proposal Inbox）

1. 展示 AI 提案列表（标题、状态、创建时间）。
2. 仅允许 `PENDING -> APPROVED` 单向确认。
3. 确认后将提案转化为 `ACTIVE campaign`。

## 2.3 收银核销（Cashier）

1. 对单笔订单给出可解释结算：
   - 券抵扣
   - 赠送金抵扣
   - 本金抵扣
   - 外部支付
2. 用于店员现场解释核销结果，减少争议。

## 2.4 风控中心（Kill Switch）

1. 一键开启/关闭熔断。
2. 熔断开启后，策略触发必须被阻断并记录日志。

---

## 3. 领域模型

1. `MerchantState`：门店、预算、熔断状态、提案、活动策略。
2. `Proposal`：`id/title/status/campaignDraft`。
3. `Campaign`：`trigger + condition + budget + action`。
4. `CashierSettlement`：结算分解与外部支付结果。

---

## 4. 核心规则

## 4.1 提案确认规则

1. 仅 `PENDING` 提案可确认。
2. 确认后提案状态变 `APPROVED`。
3. 同步加入 `activeCampaigns`。

## 4.2 TCA 触发规则

1. 若熔断开启，直接阻断。
2. 若事件与条件匹配，且 `used + costPerHit <= cap`，则执行。
3. 执行后递增活动预算消耗，并写入执行日志。

## 4.3 智能收银规则

订单按以下顺序抵扣：
1. 优惠券/口福红包。
2. 顾客赠送金。
3. 顾客本金。
4. 外部支付。

---

## 5. 工程实现要求

1. `React Native` 单工程兼容 iOS/Android。
2. 领域逻辑与 UI 解耦：
   - UI 只触发动作。
   - 规则计算由 `merchantEngine` 纯函数完成。
3. 所有关键按钮动作必须可追踪日志（最后动作可见）。

---

## 6. 测试规范

## 6.1 领域层必须覆盖

1. 提案确认后激活策略。
2. 熔断开启后阻断策略执行。
3. 收银抵扣顺序正确。

## 6.2 UI 层最低要求

1. App 可稳定挂载。
2. 核心文案与模块存在（驾驶舱/收银/TCA）。

---

## 7. 需求追踪矩阵（总规范 -> 商户端）

| ID | 总规范条款 | 商户端要求 | 验收方式 |
| :-- | :-- | :-- | :-- |
| M-01 | 无确认不执行 | 提案需人工确认后入库为活动策略 | 领域测试 `approveProposal` |
| M-02 | 紧急人工接管 | 熔断开关可一键阻断策略执行 | 领域测试 `toggleKillSwitch/triggerCampaigns` |
| M-03 | TCA 原子引擎 | 事件+条件+预算联合判定 | 触发测试 |
| M-04 | 智能收银 | 抵扣分层可解释 | `smartCashierVerify` 测试 |
| M-05 | 预算红线 | 活动执行需受预算约束 | 预算消耗断言 |

---

## 8. 商户角色推演（反推文档与代码）

## 8.1 角色 A：老板（Owner）

场景：午市前收到“暴雨急售策略”。

1. 在决策收件箱确认提案。
2. 系统将其转为可执行策略。
3. 触发天气事件后开始执行。
4. 若利润预警，立即开启熔断。

反推检查：
1. 文档需定义“确认前不可执行”。
2. 代码需体现“确认后才进入 activeCampaigns”。
3. 熔断后触发必须返回 blocked。

## 8.2 角色 B：店员（Staff）

场景：顾客结账质疑抵扣金额。

1. 店员在收银台执行智能核销。
2. 系统展示券/赠送金/本金/外部支付分解。
3. 店员按分解解释结算路径。

反推检查：
1. 文档需定义可解释结算结构。
2. 代码需返回稳定 settlement 对象。

---

## 9. 当前版本完成度说明

已完成：
1. 驾驶舱预算与熔断状态展示。
2. 决策收件箱确认链路。
3. TCA 触发演练。
4. 收银抵扣演示。
5. 商户端测试覆盖。

后续（不偏离总规范）：
1. 增加员工角色权限矩阵（Owner/Manager/Clerk）。
2. 接入推送与真实支付设备事件。
