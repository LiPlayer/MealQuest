# 有戏掌柜 - 商户端产品与工程规范 (Master-Aligned V2.0)

> 依据：`MealQuest_Spec.md`（唯一标准）
> 目标：落实“老板定战略，AI 定战术”，让商户在移动端完成策略确认、收银执行、风控熔断。

---

## 1. 规范边界（与总规范强一致）

1. 商户端是经营主控台，不承担复杂 ERP/进销存。
2. AI 仅可提案，不可越权执行；策略必须商户确认。
3. 所有营销策略必须受预算上限与熔断开关约束。
4. 商户端收银必须可解释“抵扣如何发生”。

---

## 2. 商户端模块

## 2.1 驾驶舱（Dashboard）

1. 预算使用：`budgetUsed / budgetCap`。
2. 熔断状态：`killSwitchEnabled`。
3. 待办策略数：来自决策收件箱。

## 2.2 决策收件箱（Proposal Inbox）

1. 展示 AI 提案列表（标题、状态、创建时间）。
2. 仅允许 `PENDING -> APPROVED` 单向确认。
3. 确认后将提案转化为 `ACTIVE campaign`。

## 2.3 标准营销策略库（Strategy Library）

1. 展示全量标准模板（拉新/促活/提客单/留存/社交裂变）。
2. 每个模板至少支持两类执行分支（Branch A/B）。
3. 商户可基于“模板 + 分支 + 覆盖参数”生成提案，再进入收件箱确认。
4. 提案生成后不得直接执行，必须保留“无确认不执行”。

## 2.4 活动运营中心（Campaign Ops）

1. 支持将活动策略切换为 `ACTIVE/PAUSED/ARCHIVED`。
2. 提供 `Fire Sale` 一键人工接管，生成 `Priority:999 + TTL` 急售策略。
3. 策略启停必须即时影响 TCA 触发结果。

## 2.5 连锁联盟（Alliance）

1. 支持查看与配置门店集群（cluster）。
2. 支持配置“钱包跨店互通（walletShared）”。
3. 支持按用户执行跨店资产同步（sync user）。

## 2.6 社交裂变账务（Social Ops）

1. 支持用户资产转赠（A减B增，总量守恒）。
2. 支持拼手气红包创建与领取（总额守恒，分账透明）。
3. 支持请客会话（群买单 / 老板补贴）创建、参与与结算。
4. 社交操作需具备幂等键与频控保护。

## 2.7 收银核销（Cashier）

1. 对单笔订单给出可解释结算：
   - 券抵扣
   - 赠送金抵扣
   - 本金抵扣
   - 外部支付
2. 用于店员现场解释核销结果，减少争议。

## 2.8 风控中心（Kill Switch）

1. 一键开启/关闭熔断。
2. 熔断开启后，策略触发必须被阻断并记录日志。

## 2.9 审计日志中心（Audit）

1. 展示高风险动作审计记录（支付、退款、提案、熔断、TCA）。
2. 支持按 `action/status/time` 筛选、分页加载与详情展开查看。
3. 用于门店追责与异常排查。

---

## 3. 领域模型

1. `MerchantState`：门店、预算、熔断状态、提案、活动策略。
2. `Proposal`：`id/title/status/campaignDraft`。
3. `Campaign`：`trigger + condition + budget + action + status + strategyMeta`。
4. `CashierSettlement`：结算分解与外部支付结果。
5. `StrategyTemplate`：`templateId/category/phase/branches[]/currentConfig`。

---

## 4. 核心规则

## 4.1 提案确认规则

1. 仅 `PENDING` 提案可确认。
2. 确认后提案状态变 `APPROVED`。
3. 同步加入 `activeCampaigns`。

## 4.2 TCA 触发规则

1. 若熔断开启，直接阻断。
2. 若事件与条件匹配，且 `used + costPerHit <= cap`，则执行。
3. 执行后递增活动预算消耗，并写入执行日志。

## 4.3 智能收银规则

订单按以下顺序抵扣：
1. 优惠券/口福红包。
2. 顾客赠送金。
3. 顾客本金。
4. 外部支付。

---

## 5. 工程实现要求

1. `React Native` 单工程兼容 iOS/Android。
2. 领域逻辑与 UI 解耦：
   - UI 只触发动作。
   - 规则计算由 `merchantEngine` 纯函数完成。
3. 所有关键按钮动作必须可追踪日志（最后动作可见）。

## 5.1 运行模式 (Professional Configuration)

采用了基于 `.env` 的全链路配置驱动模式（集成 `react-native-config`）：

1. **配置驱动**：商户端通过 `MealQuestMerchant/.env` 获取配置。
2. **核心变量**：
   - `MQ_SERVER_URL`：后端服务端点。
   - `MQ_MERCHANT_ID`：默认登录或注入的门店 ID。
   - `MQ_ENABLE_ENTRY_FLOW`：是否开启扫码/链接入店引导流。
3. **优势**：JS 层与原生 Android 层共享配置，支持在 `AndroidManifest.xml` 或 Gradle 中引用变量。
4. **实时事件**：通过 WebSocket 订阅支付、退款、策略变更等实时事件。
5. **故障处理**：远程 API 失败时显示明确错误，不再降级到本地引擎。
2. 实时事件流支持点击单条事件展开 payload 明细，便于店长排查现场问题。
3. 远程失败直接进入错误态并提示重试/排查，不再降级到本地推演引擎。

## 5.2 角色权限边界

1. `OWNER`：可确认提案、可熔断、可触发策略、可退款。
2. `MANAGER`：可退款、可触发策略、可生成策略提案、可启停活动，不可熔断与提案最终确认。
3. `CLERK`：可收银、看板、供应商核验，不可退款、提案确认、熔断。

---

## 6. 测试规范

## 6.1 领域层必须覆盖

1. 提案确认后激活策略。
2. 熔断开启后阻断策略执行。
3. 收银抵扣顺序正确。
4. 实时事件映射正确（类型 -> 标签/严重级别/异常标记）。
5. 审计日志映射正确（状态 -> 展示标签/严重级别）。
6. 策略模板查询、提案生成请求参数完整。

## 6.2 UI 层最低要求

1. App 可稳定挂载。
2. 核心文案与模块存在（驾驶舱/收银/TCA）。
3. 实时事件流支持“全部/仅异常”筛选与 payload 展开查看。
4. 审计日志支持动作/状态/时间筛选、分页加载与详情展开复制。
5. 策略库可生成提案并回流收件箱，急售按钮可触发人工接管。
6. 商户端需提供联盟配置、社交裂变、请客买单的可操作入口（非仅 API 存在）。
7. 可复现 UI 回归脚本需可一键执行：`npm run test:regression:ui`。

---

## 7. 需求追踪矩阵（总规范 -> 商户端）

| ID | 总规范条款 | 商户端要求 | 验收方式 |
| :-- | :-- | :-- | :-- |
| M-01 | 无确认不执行 | 提案需人工确认后入库为活动策略 | 领域测试 `approveProposal` |
| M-02 | 紧急人工接管 | 熔断开关可一键阻断策略执行 | 领域测试 `toggleKillSwitch/triggerCampaigns` |
| M-03 | TCA 原子引擎 | 事件+条件+预算联合判定 | 触发测试 |
| M-04 | 智能收银 | 抵扣分层可解释 | `smartCashierVerify` 测试 |
| M-05 | 预算红线 | 活动执行需受预算约束 | 预算消耗断言 |
| M-06 | 标准营销策略库 | 模板分支可生成提案并人工确认执行 | 集成测试 |
| M-07 | 紧急人工接管 | 支持 `Priority:999 + TTL` 急售策略 | 集成测试 |
| M-08 | 多店连锁联盟 | 支持钱包互通配置与用户跨店同步 | 集成测试 |
| M-09 | 社交裂变账务 | 转赠/红包总量守恒且可审计 | 集成测试 |
| M-10 | 请客买单 | 群买单/老板补贴可结算且受补贴上限约束 | 集成测试 |

---

## 8. 商户角色推演（反推文档与代码）

## 8.1 角色 A：老板（Owner）

场景：午市前收到“暴雨急售策略”。

1. 在决策收件箱确认提案。
2. 系统将其转为可执行策略。
3. 触发天气事件后开始执行。
4. 若利润预警，立即开启熔断。

反推检查：
1. 文档需定义“确认前不可执行”。
2. 代码需体现“确认后才进入 activeCampaigns”。
3. 熔断后触发必须返回 blocked。

## 8.2 角色 B：店员（Staff）

场景：顾客结账质疑抵扣金额。

1. 店员在收银台执行智能核销。
2. 系统展示券/赠送金/本金/外部支付分解。
3. 店员按分解解释结算路径。

反推检查：
1. 文档需定义可解释结算结构。
2. 代码需返回稳定 settlement 对象。

---

## 9. 当前版本完成度说明

已完成：
1. 驾驶舱预算与熔断状态展示。
2. 决策收件箱确认链路。
3. 策略库模板检索、分支提案生成与确认闭环。
4. 收银抵扣演示。
5. 商户端测试覆盖。
6. 可选远程联调模式（服务端 API）。
7. 审计日志读取、动作/状态/时间筛选、分页与详情查看。
8. 活动策略启停控制与紧急急售入口。
9. 供应商订单核验入口（用于异业联盟交易校验）。
10. 连锁联盟配置能力（门店列表/共享钱包/用户同步）。
11. 社交裂变账务能力（转赠/拼手气红包）。
12. 请客买单能力（群买单/老板补贴会话）。

后续（不偏离总规范）：
1. 接入真实支付设备事件（POS/扫码枪）并补充设备异常演练。
2. 增加审计日志导出与异常告警订阅。
