var UNIFIED_SHRINK_FACTOR = 0.3; // Shrink TO 70%
var OCCLUSION_BUFFER = 48; // Logic accounts for header shadow/blur overlap

function onScroll(e, ownerInstance) {
  var scrollTop = e.detail.scrollTop;
  var dataset = e.currentTarget.dataset;
  
  // Dynamic ranges from dataset (passed from index.js via index.wxml)
  var brandH = dataset.brandH || 208;
  var cardH = dataset.cardH || 825;

  // 1. Select elements
  var brandEl = ownerInstance.selectComponent('.wxs-shop-brand-scroll-wrapper');
  var titleEl = ownerInstance.selectComponent('.wxs-header-store-name');
  var headerBgEl = ownerInstance.selectComponent('.wxs-header-bg');
  var cardEl = ownerInstance.selectComponent('.wxs-card-stack-section');

  // 2. ShopBrand Animation
  if (brandEl) {
    var brandRange = brandH - OCCLUSION_BUFFER;
    var p1 = Math.min(1, Math.max(0, scrollTop / brandRange));
    
    // Scale standard: use card's displacement rate (0.3 / cardH)
    var scale = (1 - (scrollTop / cardH) * UNIFIED_SHRINK_FACTOR).toFixed(4);
    var opacity = (p1 > 0.8 ? 1 - (p1 - 0.8) / 0.2 : 1).toFixed(2);

    brandEl.setStyle({
      'transform': 'scale(' + scale + ')',
      'opacity': opacity
    });
  }

  // 2.5 Header Background Animation
  if (headerBgEl) {
    var hp = Math.min(1, Math.max(0, scrollTop / 100));
    headerBgEl.setStyle({ 'opacity': hp.toFixed(2) });
  }

  // 3. Header Title Animation
  if (titleEl) {
    var tp = Math.min(1, Math.max(0, (scrollTop - 120) / 80));
    var tx = Math.floor((1 - tp) * -16);
    titleEl.setStyle({
      'opacity': tp.toFixed(2),
      'transform': 'translate3d(' + tx + 'px, 0, 0)'
    });
  }

  // 4. Card Stack Animation
  if (cardEl) {
    // Standardized scaling: both start from scrollTop 0 for a unified "speed"
    // but Card Stack only starts taking effect after brand starts folding
    var cardScale = (1 - (scrollTop / cardH) * UNIFIED_SHRINK_FACTOR).toFixed(4);
    
    var cardStart = brandH - OCCLUSION_BUFFER;
    var phase2p = Math.min(1, Math.max(0, (scrollTop - cardStart) / cardH));
    var opacityCard = (1 - phase2p * 0.5).toFixed(2);

    cardEl.setStyle({
      'transform': 'scale(' + cardScale + ')',
      'opacity': opacityCard
    });
  }
}


module.exports = {
  onScroll: onScroll
};
