# é¤é¤æœ‰æˆ - æœåŠ¡ç«¯æŠ€æœ¯æž¶æž„è§„èŒƒ (Master-Aligned V2.0)

> ä¾æ®ï¼š`MealQuest_Spec.md`ï¼ˆå”¯ä¸€æ ‡å‡†ï¼‰
> ç›®æ ‡ï¼šæž„å»ºå¯è¿è¡Œçš„æ ¸å¿ƒåŽç«¯é—­çŽ¯ï¼Œæ‰¿è½½èµ„äº§è´¦æœ¬ã€æ”¯ä»˜æ ¸é”€ã€é€€æ¬¾å›žæº¯ã€TCA æ‰§è¡Œä¸Žç­–ç•¥ç¡®è®¤ã€‚

---

## 1. æž¶æž„ç›®æ ‡ä¸Žè¾¹ç•Œ

1. æœåŠ¡ç«¯è´Ÿè´£â€œè§„åˆ™å†³ç­–ä¸ŽçŠ¶æ€è½è´¦â€ï¼Œä¸è´Ÿè´£ç‚¹é¤æµç¨‹ã€‚
2. é¢å‘å°å¾®é¤é¥®ç§åŸŸï¼šä¼˜å…ˆä¿éšœæ­£ç¡®æ€§ä¸Žå¯è¿½æº¯ã€‚
3. æ‰€æœ‰é«˜é£Žé™©åŠ¨ä½œå¿…é¡»æ»¡è¶³ï¼š
   - å¹‚ç­‰
   - å¯è¿½è¸ª ledger
   - å¯äººå·¥ç†”æ–­

---

## 2. å½“å‰å·¥ç¨‹å½¢æ€

ç›®å½•ï¼š`MealQuestServer/`

1. `src/core/`ï¼šçº¯ç®—æ³•å†…æ ¸ã€‚
2. `src/services/`ï¼šæ”¯ä»˜ã€ç­–ç•¥ã€å•†æˆ·æŽ§åˆ¶ç”¨ä¾‹ã€‚
3. `src/store/`ï¼šå†…å­˜ä»“å‚¨ï¼ˆå¯æ›¿æ¢æ•°æ®åº“ï¼‰ã€‚
4. `src/http/`ï¼šNode HTTP APIã€‚
5. `test/`ï¼š`node:test` å•æµ‹ä¸Žé›†æˆæµ‹è¯•ã€‚
6. `.env`ï¼šçŽ¯å¢ƒé…ç½®æ–‡ä»¶ï¼ˆç”± `dotenv` åŠ è½½ï¼‰ã€‚

---

## 3. æ•°æ®æ¨¡åž‹

## 3.1 ç”¨æˆ·ä¸Žèµ„äº§

1. `wallet.principal`ï¼šæœ¬é‡‘ï¼ˆå¯é€€ï¼‰ã€‚
2. `wallet.bonus`ï¼šèµ é€é‡‘ï¼ˆä¸å¯æçŽ°ï¼‰ã€‚
3. `wallet.silver`ï¼šå¯»å‘³ç¢Žé“¶ã€‚
4. `vouchers[]`ï¼šå£ç¦çº¢åŒ…çŠ¶æ€ï¼ˆ`ACTIVE/USED`ï¼‰ã€‚
5. `merchantUsers[merchantId][userId]`ï¼šç”¨æˆ·æ•°æ®æŒ‰å•†æˆ·åŸŸåˆ†æ¡¶å­˜å‚¨ï¼ˆå…±äº«åº“å¼ºéš”ç¦»ï¼‰ã€‚

## 3.2 å•†æˆ·ä¸Žé£ŽæŽ§

1. `killSwitchEnabled`ï¼šç†”æ–­çŠ¶æ€ã€‚
2. `budgetCap/budgetUsed`ï¼šè¥é”€é¢„ç®—çº¢çº¿ã€‚
3. `campaigns[]`ï¼šå·²æ¿€æ´»ç­–ç•¥ã€‚
4. `proposals[]`ï¼šå¾…ç¡®è®¤ AI ææ¡ˆã€‚
5. `tenantPolicies[merchantId]`ï¼šç§Ÿæˆ·ç­–ç•¥ï¼ˆå†™å†»ç»“/å®žæ—¶å¼€å…³/é™æµé…é¢ï¼‰ã€‚
6. `tenantMigrations[merchantId]`ï¼šè¿ç§»ç¼–æŽ’çŠ¶æ€ï¼ˆphase/step/note/updatedAtï¼‰ã€‚
7. `tenantRouteFiles[merchantId]`ï¼šä¸“åº“è·¯ç”±æ–‡ä»¶ï¼ˆé‡å¯åŽæ¢å¤å•†æˆ·ä¸“åº“ç»‘å®šï¼‰ã€‚
8. `strategyConfigs[merchantId][templateId]`ï¼šç­–ç•¥æ¨¡æ¿å¯åœä¸Žåˆ†æ”¯é…ç½®çŠ¶æ€ï¼ˆDRAFT/PENDING_APPROVAL/ACTIVEï¼‰ã€‚
9. `allianceConfigs[merchantId]`ï¼šè¿žé”é›†ç¾¤é…ç½®ï¼ˆclusterId/stores/walletShared/tierSharedï¼‰ã€‚

## 3.3 èµ„é‡‘ä¸Žæµæ°´

1. `paymentsByMerchant[merchantId][paymentTxnId]`ï¼šæ”¯ä»˜è®°å½•ä¸Žå·²é€€æ¬¾é‡‘é¢æŒ‰å•†æˆ·åˆ†æ¡¶ã€‚
2. `ledger[]`ï¼š`PAYMENT/REFUND` æµæ°´ã€‚
3. `idempotencyMap`ï¼šå¹‚ç­‰ç¼“å­˜ã€‚
4. `partnerOrders[partnerId][orderId]`ï¼šå¼‚ä¸šè”ç›Ÿä¾›åº”å•†è®¢å•æ ¸éªŒç¼“å­˜ï¼ˆç”¨äºŽ Cross-Promo B åˆ†æ”¯äº¤æ˜“æ ¡éªŒï¼‰ã€‚

---

## 4. æ ¸å¿ƒç®—æ³•è§„èŒƒ

## 4.1 æ™ºèƒ½æ”¯ä»˜ `buildCheckoutQuote`

é¡ºåºï¼š
1. ä¸´æœŸå¯ç”¨åˆ¸ä¼˜å…ˆã€‚
2. æ‰£èµ é€é‡‘ã€‚
3. æ‰£æœ¬é‡‘ã€‚
4. æ‰£ç¢Žé“¶ã€‚
5. ä½™é¢ä¸è¶³èµ°å¤–éƒ¨æ”¯ä»˜ã€‚

è¾“å‡ºï¼š`deduction + payable + remainingWallet`ã€‚

## 4.2 é€€æ¬¾å›žæº¯ `applyRefundClawback`

åŽŸåˆ™ï¼š
1. é€€æ¬¾æ—¶ä¼˜å…ˆå›žæ”¶èµ é€é‡‘æ¶ˆè€—ã€‚
2. è‹¥èµ é€é‡‘ä¸è¶³ï¼Œè½¬ä¸ºå›žæ”¶æœ¬é‡‘ã€‚
3. ä¿è¯ç»“æžœå¯è§£é‡Šï¼š`fromBonus / fromPrincipal`ã€‚

## 4.3 TCA æ‰§è¡Œ `runTcaEngine`

æ‰§è¡Œå‰ç½®ï¼š
1. ç†”æ–­å…³é—­ã€‚
2. äº‹ä»¶åŒ¹é…ã€‚
3. æ¡ä»¶å…¨éƒ¨æ»¡è¶³ï¼ˆANDï¼‰ã€‚
4. é¢„ç®—æœªè¶…é™ã€‚

æ‰§è¡Œç»“æžœï¼š
1. ç­–ç•¥æ‰§è¡Œ ID åˆ—è¡¨ã€‚
2. Story JSON æ³¨å…¥åˆ—è¡¨ã€‚
3. é¢„ç®—æ¶ˆè€—é€’å¢žã€‚

## 4.4 Story JSON ç»“æž„æ ¡éªŒ

æœ€å°å¿…å¡«ï¼š
1. `templateId`
2. `narrative`
3. `assets[]`
4. `triggers[]`

ç¼ºå¤±å­—æ®µä¸€å¾‹æ‹’ç»ä¸‹å‘ã€‚

---

## 5. API å¥‘çº¦ï¼ˆV2ï¼‰

## 5.1 è¯»çŠ¶æ€

1. `GET /health`
2. `GET /api/state?merchantId=&userId=`
3. `GET /api/merchant/dashboard?merchantId=`
4. `GET /api/merchant/strategy-library?merchantId=`
5. `GET /api/merchant/strategy-configs?merchantId=`
6. `GET /api/audit/logs?merchantId=&limit=&cursor=&startTime=&endTime=&action=&status=`
7. `GET /api/ws/status?merchantId=`ï¼ˆå•†æˆ·åœ¨çº¿çŠ¶æ€ï¼‰
8. `GET /api/merchant/alliance-config?merchantId=`
9. `GET /api/merchant/stores?merchantId=`

## 5.1.1 é‰´æƒ

1. `POST /api/auth/customer/wechat-login`ï¼šå°ç¨‹åºå¾®ä¿¡ç™»å½•æ¢å–é¡¾å®¢ä»¤ç‰Œã€‚
2. `POST /api/auth/merchant/request-code`ï¼šå•†æˆ·ç«¯è¯·æ±‚æ‰‹æœºå·éªŒè¯ç ã€‚
3. `POST /api/auth/merchant/phone-login`ï¼šå•†æˆ·ç«¯æ‰‹æœºå·éªŒè¯ç ç™»å½•æ¢å–è¿è¥ä»¤ç‰Œã€‚
4. ç”¨æˆ·ç«¯æ‰‹æœºå·ä½œä¸ºé¡¾å®¢å”¯ä¸€å‡­è¯ï¼Œç”±æœåŠ¡ç«¯åœ¨ `wechat-login` è¿‡ç¨‹ä¸­è‡ªåŠ¨ç»‘å®šã€‚
   - è‹¥ç™»å½•é˜¶æ®µæ— æ³•èŽ·å¾—æ‰‹æœºå·ï¼ŒæœåŠ¡ç«¯æ‹’ç»ç™»å½•ï¼Œä¸å…è®¸ç»§ç»­æ“ä½œã€‚
5. é™¤ `/health` ä¸Žç™»å½•æŽ¥å£å¤–ï¼Œå…¶ä½™æŽ¥å£å‡è¦æ±‚ `Authorization: Bearer <token>`ã€‚
6. è§’è‰²çº¦æŸï¼š
   - `CUSTOMER`ï¼šå¯æ”¯ä»˜æŠ¥ä»·/æ”¯ä»˜æ‰§è¡Œ/è¯»å–è‡ªèº«çŠ¶æ€ã€‚
   - `CLERK`ï¼šå¯çœ‹é©¾é©¶èˆ±ã€å¯æ‰§è¡Œæ”¶é“¶ï¼Œä¸å¯ç¡®è®¤ææ¡ˆ/ç†”æ–­ã€‚
   - `MANAGER`ï¼šå¯é€€æ¬¾ã€å¯è§¦å‘ TCAï¼Œä¸å¯ç†”æ–­ä¸Žæœ€ç»ˆææ¡ˆç¡®è®¤ã€‚
   - `OWNER`ï¼šæ‹¥æœ‰å…¨éƒ¨ç»è¥æŽ§åˆ¶æƒé™ã€‚

## 5.1.2 å®žæ—¶é€šé“

1. `GET ws://<host>/ws?merchantId=<id>&token=<jwt>`ï¼šå»ºç«‹å•†æˆ·åŸŸå®žæ—¶é€šé“ã€‚
2. æœåŠ¡ç«¯å¹¿æ’­äº‹ä»¶ç±»åž‹ï¼š
   - `PAYMENT_VERIFIED`
   - `PAYMENT_REFUNDED`
   - `PROPOSAL_CONFIRMED`
   - `KILL_SWITCH_CHANGED`
   - `TCA_TRIGGERED`
   - `STRATEGY_CHAT_MESSAGE`
   - `CAMPAIGN_STATUS_CHANGED`
   - `FIRE_SALE_CREATED`

## 5.2 æ”¯ä»˜ä¸Žé€€æ¬¾

1. `POST /api/payment/quote`
2. `POST /api/payment/verify`ï¼ˆè¦æ±‚ `Idempotency-Key`ï¼‰
3. `POST /api/payment/refund`ï¼ˆè¦æ±‚ `Idempotency-Key`ï¼‰
4. `POST /api/payment/callback`ï¼ˆå¤–éƒ¨æ”¯ä»˜å›žè°ƒï¼ŒHMAC éªŒç­¾ï¼‰
5. `GET /api/payment/ledger?merchantId=&userId=&limit=`ï¼ˆé¡¾å®¢/å•†æˆ·è´¦åŠ¡æŸ¥è¯¢ï¼‰

## 5.2.1 å‘ç¥¨ä¸Žéšç§åˆè§„

1. `POST /api/invoice/issue`ï¼ˆå·²ç»“ç®—æ”¯ä»˜å¼€ç¥¨ï¼‰
2. `GET /api/invoice/list?merchantId=&userId=&limit=`ï¼ˆé¡¾å®¢ä»…å¯æŸ¥è¯¢æœ¬äººï¼Œå•†æˆ·å¯æŒ‰ scope æŸ¥è¯¢ï¼‰
3. `POST /api/privacy/export-user`ï¼ˆOwnerï¼Œç§Ÿæˆ·èŒƒå›´å¯¼å‡ºï¼‰
4. `POST /api/privacy/delete-user`ï¼ˆOwnerï¼Œç§Ÿæˆ·èŒƒå›´åŒ¿ååŒ–ï¼‰
5. `POST /api/privacy/cancel-account`ï¼ˆCustomerï¼Œè‡ªåŠ©æ³¨é”€å¹¶ç‰©ç†åˆ é™¤éžäº¤æ˜“æ¡£æ¡ˆï¼‰

## 5.3 ç­–ç•¥ä¸Žé£ŽæŽ§

1. `POST /api/merchant/proposals/:id/confirm`
2. `POST /api/merchant/kill-switch`
3. `POST /api/tca/trigger`
4. `GET /api/merchant/tenant-policy?merchantId=`ï¼ˆä»… `OWNER`ï¼‰
5. `POST /api/merchant/tenant-policy`ï¼ˆä»… `OWNER`ï¼Œå¯æ›´æ–°å†™å†»ç»“/å®žæ—¶å¼€å…³/é…é¢ï¼‰
6. `GET /api/merchant/migration/status?merchantId=`ï¼ˆä»… `OWNER`ï¼‰
7. `POST /api/merchant/migration/step`ï¼ˆä»… `OWNER`ï¼Œæ‰§è¡Œå†»ç»“/è§£å†»/ç¼–æŽ’æ ‡è®°ï¼‰
8. `POST /api/merchant/migration/cutover`ï¼ˆä»… `OWNER`ï¼Œè‡ªåŠ¨å†»ç»“->åˆ‡åº“->æ¢å¤å†™å…¥ï¼‰
9. `POST /api/merchant/migration/rollback`ï¼ˆä»… `OWNER`ï¼Œè‡ªåŠ¨å†»ç»“->å›žæµå…±äº«åº“->æ¢å¤å†™å…¥ï¼‰
10. `POST /api/merchant/strategy-chat/messages`ï¼ˆ`MANAGER/OWNER`ï¼ŒæŒ‰æ¨¡æ¿ä¸Žåˆ†æ”¯ç”Ÿæˆå¾…ç¡®è®¤ææ¡ˆï¼‰
11. `POST /api/merchant/campaigns/:id/status`ï¼ˆ`MANAGER/OWNER`ï¼Œç­–ç•¥å¯åœ/å½’æ¡£ï¼‰
12. `POST /api/merchant/fire-sale`ï¼ˆ`MANAGER/OWNER`ï¼Œåˆ›å»º `Priority:999` æ‰‹åŠ¨æ€¥å”®ç­–ç•¥ï¼‰
13. `POST /api/supplier/verify-order`ï¼ˆ`CLERK+`ï¼Œæ ¸éªŒå¼‚ä¸šè”ç›Ÿè®¢å•çœŸä¼ªä¸Žé—¨æ§›ï¼‰
14. `POST /api/merchant/alliance-config`ï¼ˆ`OWNER`ï¼Œé…ç½®å¤šåº—è¿žé”äº’é€šè§„åˆ™ï¼‰
15. `POST /api/merchant/alliance/sync-user`ï¼ˆ`MANAGER/OWNER`ï¼Œæ‰§è¡Œè·¨åº—ç”¨æˆ·èµ„äº§åŒæ­¥ï¼‰
16. ç¤¾äº¤ç›¸å…³æŽ¥å£ï¼ˆ`/api/social/*`ï¼‰å½“å‰ç‰ˆæœ¬å·²ç§»é™¤ï¼Œä¸çº³å…¥æœåŠ¡ç«¯å¥‘çº¦ã€‚

---

## 6. å®‰å…¨ä¸Žå¯è§‚æµ‹æ€§æœ€å°è¦æ±‚

1. å…³é”®èµ„é‡‘æŽ¥å£å¿…é¡»å¹‚ç­‰ã€‚
2. æ”¯ä»˜/é€€æ¬¾å¿…é¡»å†™ ledgerã€‚
3. ç­–ç•¥æ‰§è¡Œéœ€å¯è¿½æº¯æ‰§è¡Œ IDã€‚
4. Story JSON ä¸‹å‘å‰å¿…é¡» schema æ ¡éªŒã€‚
5. JWT ä»¤ç‰Œå¿…é¡»æ ¡éªŒç­¾åä¸Žè¿‡æœŸæ—¶é—´ã€‚
6. èµ„é‡‘ä¸Žç”¨æˆ·æŸ¥è¯¢å¿…é¡»æºå¸¦å¹¶æ ¡éªŒ `merchantId` ç§Ÿæˆ·è¾¹ç•Œã€‚
7. é«˜é£Žé™©åŠ¨ä½œå¿…é¡»è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆ`who/when/tenant/action/status/details`ï¼‰ã€‚
8. å®¡è®¡æŸ¥è¯¢æŽ¥å£ä»…å•†æˆ·è§’è‰²å¯è®¿é—®ï¼Œä¸”å¿…é¡»å—å•†æˆ· scope é™åˆ¶ã€‚
9. `ws/status` æŸ¥è¯¢å¿…é¡»æ ¡éªŒå•†æˆ· scopeï¼Œç¦æ­¢è·¨å•†æˆ·è¯»å–åœ¨çº¿çŠ¶æ€ã€‚
10. å¤šç§Ÿæˆ·ç­–ç•¥å±‚å¿…é¡»æ”¯æŒâ€œå†™å†»ç»“ï¼ˆread-onlyï¼‰+ æ¯å•†æˆ·é…é¢é™æµâ€åŒé—¸é—¨ã€‚
11. ç§Ÿæˆ·ç­–ç•¥ç®¡ç†æŽ¥å£å¿…é¡»ä»… `OWNER` å¯å†™ï¼Œä¸”å—å•†æˆ· scope é™åˆ¶ã€‚
12. åˆ‡åº“åŽè·¯ç”±å…ƒæ•°æ®å¿…é¡»æŒä¹…åŒ–ï¼Œé˜²æ­¢é‡å¯åŽå•†æˆ·æµé‡å›žæµå…±äº«åº“ã€‚
13. å¤–éƒ¨æ”¯ä»˜å›žè°ƒå¿…é¡»é€šè¿‡ç­¾åæ ¡éªŒåŽæ‰å¯å…¥è´¦ã€‚
14. å‘ç¥¨æŽ¥å£å¿…é¡»åªå…è®¸å¯¹å·²ç»“ç®—æ”¯ä»˜å¼€ç¥¨ï¼Œé˜²æ­¢æœªæ”¶æ¬¾å…ˆå¼€ç¥¨ã€‚
15. éšç§å¯¼å‡º/åˆ é™¤å¿…é¡»é™å®š Owner ä¸”å—ç§Ÿæˆ· scope çº¦æŸã€‚
16. é¡¾å®¢ç«¯å¿…é¡»æ”¯æŒè‡ªåŠ©æ³¨é”€è´¦å·ï¼Œæ³¨é”€åŽéžäº¤æ˜“ç±»æ¡£æ¡ˆç‰©ç†åˆ é™¤ï¼Œäº¤æ˜“ç±»æ•°æ®ä»…ä¿ç•™åŒ¿åæ ‡è¯†ã€‚
17. å¿…é¡»æä¾›åŸºç¡€æŒ‡æ ‡æŽ¥å£ï¼ˆè¯·æ±‚æ•°/é”™è¯¯æ•°ï¼‰ç”¨äºŽä¸Šçº¿ç›‘æŽ§æŽ¥å…¥ã€‚
18. ç­–ç•¥åº“å¿…é¡»å¯é…ç½®å®Œæ•´è¥é”€ç­–ç•¥åˆ†æ”¯ï¼Œä¸”ä»éµå®ˆâ€œæ— ç¡®è®¤ä¸æ‰§è¡Œâ€ã€‚
19. ä¾›åº”å•†æ ¸éªŒå¿…é¡»å¯è¿½æº¯å¹¶å†™å®¡è®¡æ—¥å¿—ï¼Œé¿å…è·¨åº—ä¼ªé€ è”ç›Ÿäº¤æ˜“ã€‚
20. é¡¾å®¢ä¾§è´¦åŠ¡æŸ¥è¯¢æŽ¥å£ï¼ˆ`payment/ledger`ã€`invoice/list`ï¼‰å¿…é¡»æ‰§è¡Œ `merchantId + userId` åŒ scope æ ¡éªŒã€‚

---

## 7. æµ‹è¯•è§„èŒƒ

## 7.1 å•å…ƒæµ‹è¯•

1. `smartCheckout.test.js`ï¼šæŠµæ‰£é¡ºåºä¸Žå¤–éƒ¨æ”¯ä»˜ã€‚
2. `clawback.test.js`ï¼šèµ é€é‡‘ä¼˜å…ˆå›žæ”¶ä¸Žæœ¬é‡‘å…œåº•ã€‚
3. `tcaEngine.test.js`ï¼šé¢„ç®—åˆ¤å®šä¸Žç†”æ–­é˜»æ–­ã€‚

## 7.2 é›†æˆæµ‹è¯•

`http.integration.test.js` å¿…é¡»è¦†ç›–ï¼š
1. æŠ¥ä»·
2. æ”¯ä»˜
3. é€€æ¬¾
4. ææ¡ˆç¡®è®¤
5. å¤©æ°”è§¦å‘ç­–ç•¥æ‰§è¡Œ
6. RBACï¼š`CLERK` ç¦æ­¢ææ¡ˆç¡®è®¤ï¼Œ`MANAGER` å¯é€€æ¬¾
7. WebSocketï¼šæ”¯ä»˜äº‹ä»¶æŽ¨é€ä¸Žåœ¨çº¿è¿žæŽ¥æ•°çŠ¶æ€ï¼ˆå«è·¨å•†æˆ· scope æ‹’ç»ï¼‰
8. æŒä¹…åŒ–ï¼šé‡å¯åŽçŠ¶æ€å¯æ¢å¤
9. å¤šç§Ÿæˆ·éš”ç¦»ï¼šåŒ `userId` åœ¨ä¸åŒå•†æˆ·åŸŸæ•°æ®äº’ä¸å½±å“ï¼Œè·¨å•†æˆ·é€€æ¬¾æ‹’ç»
10. ç§Ÿæˆ·è·¯ç”±ï¼šå¯æŒ‰ `merchantId` è·¯ç”±åˆ°å•†æˆ·ä¸“å±žæ•°æ®æº
11. å®¡è®¡æ—¥å¿—ï¼šé«˜é£Žé™©åŠ¨ä½œæˆåŠŸ/æ‹’ç»å‡æœ‰è½è´¦
12. å®¡è®¡æŸ¥è¯¢ï¼šåˆ†é¡µ/æ¸¸æ ‡å¯è¯»ï¼Œä¸”å®¢æˆ·è§’è‰²ä¸å¯è®¿é—®
13. ç§Ÿæˆ·ç­–ç•¥ï¼šå•†æˆ·å†™å†»ç»“ç”Ÿæ•ˆä¸”è¿”å›žæ˜Žç¡®é”™è¯¯ç 
14. ç§Ÿæˆ·é…é¢ï¼šå•å•†æˆ·è¶…é™è¿”å›ž `429`ï¼Œä¸”ä¸å½±å“å…¶ä»–å•†æˆ·
15. ç§Ÿæˆ·ç­–ç•¥ç®¡ç†ï¼šä»… Owner å¯æ›´æ–°ï¼Œè·¨å•†æˆ·ä¿®æ”¹å¿…é¡»æ‹’ç»
16. ç§Ÿæˆ·ç­–ç•¥æŒä¹…åŒ–ï¼šé‡å¯åŽç­–ç•¥ä»ä¿æŒç”Ÿæ•ˆ
17. è¿ç§»ç¼–æŽ’ï¼šå†»ç»“/è§£å†»æ­¥éª¤å¯åœ¨çº¿æ‰§è¡Œå¹¶é©±åŠ¨ç§Ÿæˆ·ç­–ç•¥è”åŠ¨
18. è‡ªåŠ¨åˆ‡åº“ï¼š`migration/cutover` æ‰§è¡ŒåŽå†™æµé‡è¿›å…¥ä¸“åº“ä¸”é‡å¯å¯æ¢å¤
19. è‡ªåŠ¨å›žæ»šï¼š`migration/rollback` åŽå•†æˆ·è·¯ç”±å›žå…±äº«åº“å¹¶æ¢å¤å†™æµé‡
20. å¤–éƒ¨æ”¯ä»˜å›žè°ƒï¼šç­¾åéžæ³•æ‹’ç»ï¼Œåˆæ³•å›žè°ƒå¯å®Œæˆå¼‚æ­¥ç»“ç®—
21. å‘ç¥¨åŠ©æ‰‹ï¼šæœªç»“ç®—è®¢å•æ‹’ç»å¼€ç¥¨ï¼Œå·²ç»“ç®—è®¢å•å¯æˆåŠŸå¼€ç¥¨
22. éšç§åˆè§„ï¼šOwner å¯å¯¼å‡ºä¸ŽåŒ¿ååŒ–åˆ é™¤ï¼Œéž Owner æ‹’ç»
23. æŒ‡æ ‡æŽ¥å£ï¼š`/metrics` å¯è¯»å¹¶è¾“å‡ºè¯·æ±‚/é”™è¯¯è®¡æ•°
24. ç­–ç•¥åº“ï¼šå¯æŸ¥è¯¢æ¨¡æ¿åº“å¹¶æŒ‰æ¨¡æ¿+åˆ†æ”¯ç”Ÿæˆææ¡ˆï¼Œç¡®è®¤åŽè¿›å…¥æ´»åŠ¨ç­–ç•¥
25. ç­–ç•¥å¯åœï¼š`campaign status` æ”¹å˜å¯ç«‹å³å½±å“ TCA æ‰§è¡Œç»“æžœ
26. ç´§æ€¥æ€¥å”®ï¼šå¯åˆ›å»º `Priority:999 + TTL` äººå·¥æŽ¥ç®¡ç­–ç•¥å¹¶è§¦å‘æ‰§è¡Œ
27. ä¾›åº”å•†æ ¸éªŒï¼šè”ç›Ÿè®¢å•æ ¸éªŒæˆåŠŸ/å¤±è´¥å‡å¯è¿”å›žå¹¶è½å®¡è®¡
28. å¤šåº—è¿žé”ï¼šå¯é…ç½®è·¨åº—å…±äº«é’±åŒ…å¹¶åœ¨æ”¯ä»˜é“¾è·¯ç”Ÿæ•ˆ
29. é¡¾å®¢è‡ªåŠ©æ³¨é”€ï¼šæ³¨é”€åŽè´¦å·ä¸å¯å†æ¬¡ç™»å½•ï¼Œäº¤æ˜“è®°å½•åŒ¿åä¿ç•™
30. é¡¾å®¢è´¦åŠ¡ä¸­å¿ƒï¼šé¡¾å®¢å¯æŸ¥è¯¢æœ¬äººæµæ°´ä¸Žå‘ç¥¨ï¼Œè·¨ç”¨æˆ·/è·¨å•†æˆ·æŸ¥è¯¢æ‹’ç»

---

## 8. éœ€æ±‚è¿½è¸ªçŸ©é˜µï¼ˆæ€»è§„èŒƒ -> æœåŠ¡ç«¯ï¼‰

| ID | æ€»è§„èŒƒæ¡æ¬¾ | æœåŠ¡ç«¯è¦æ±‚ | éªŒæ”¶æ–¹å¼ |
| :-- | :-- | :-- | :-- |
| S-01 | èµ„äº§ç»æµŽç³»ç»Ÿ | é’±åŒ…/å£ç¦çº¢åŒ…/ç¢Žé“¶ç»Ÿä¸€è´¦æœ¬ | æ”¯ä»˜é“¾è·¯æµ‹è¯• |
| S-02 | æ™ºèƒ½æ”¶é“¶é—­çŽ¯ | æŠ¥ä»·ä¸Žæ ¸é”€å¯è§£é‡Š | `quote/verify` æµ‹è¯• |
| S-03 | Clawback é£ŽæŽ§ | é€€æ¬¾å›žæº¯èµ é€é‡‘ä¼˜å…ˆ | `clawback` æµ‹è¯• |
| S-04 | æ— ç¡®è®¤ä¸æ‰§è¡Œ | ææ¡ˆç¡®è®¤åŽæ‰æ¿€æ´»ç­–ç•¥ | API é›†æˆæµ‹è¯• |
| S-05 | Kill Switch | ç†”æ–­åŽç­–ç•¥è§¦å‘é˜»æ–­ | `tcaEngine` + API æµ‹è¯• |
| S-06 | Story Protocol | ä¸‹å‘å‰å¼ºæ ¡éªŒ | `storyProtocol` é€»è¾‘æ–­è¨€ |

---

## 9. ç”¨æˆ·/å•†æˆ·åŒè§’è‰²åœºæ™¯æŽ¨æ¼”ï¼ˆåæŽ¨æ–‡æ¡£ä¸Žä»£ç ï¼‰

## 9.1 ç”¨æˆ·è§†è§’ï¼šæ”¯ä»˜ + é€€æ¬¾

1. ç”¨æˆ·æ”¯ä»˜æ—¶ä¼˜å…ˆåƒæŽ‰ä¸´æœŸåˆ¸ä¸Žä½™é¢ã€‚
2. æ”¯ä»˜æˆåŠŸåŽæµæ°´å¯æŸ¥ã€‚
3. å‘ç”Ÿé€€æ¬¾æ—¶ï¼Œç³»ç»Ÿä¼˜å…ˆå›žæ”¶èµ é€é‡‘æƒç›Šã€‚

åæŽ¨æ£€æŸ¥ï¼š
1. æ–‡æ¡£å¿…é¡»å®šä¹‰æŠµæ‰£é¡ºåºä¸Žé€€æ¬¾å›žæº¯ã€‚
2. ä»£ç å¿…é¡»è¿”å›žå¯è§£é‡Š deduction/clawbackã€‚
3. æµ‹è¯•å¿…é¡»éªŒè¯é‡‘é¢å˜åŒ–æ­£ç¡®ã€‚

## 9.2 å•†æˆ·è§†è§’ï¼šç­–ç•¥ç¡®è®¤ + ç†”æ–­

1. è€æ¿æ”¶åˆ° AI ææ¡ˆï¼Œç‚¹å‡»ç¡®è®¤ã€‚
2. å¤©æ°”äº‹ä»¶è§¦å‘åŽç­–ç•¥æ‰§è¡Œå¹¶æ¶ˆè€—é¢„ç®—ã€‚
3. æ¯›åˆ©é£Žé™©æ—¶è€æ¿å¼€å¯ç†”æ–­ï¼ŒåŽç»­è§¦å‘å…¨éƒ¨é˜»æ–­ã€‚

åæŽ¨æ£€æŸ¥ï¼š
1. æ–‡æ¡£å¿…é¡»å®šä¹‰â€œç¡®è®¤åŽæ‰§è¡Œâ€ä¸Žç†”æ–­ä¼˜å…ˆçº§ã€‚
2. ä»£ç å¿…é¡»å®žçŽ° proposal -> campaign è½¬æ¢ã€‚
3. æµ‹è¯•å¿…é¡»è¦†ç›– blockedByKillSwitchã€‚

---

## 10. å½“å‰ç‰ˆæœ¬å®Œæˆåº¦è¯´æ˜Ž

å·²å®Œæˆï¼š
1. æ™ºèƒ½æŠµæ‰£å†…æ ¸ã€‚
2. é€€æ¬¾å›žæº¯å†…æ ¸ã€‚
3. TCA + Story æ ¡éªŒã€‚
4. ææ¡ˆç¡®è®¤ä¸Žç†”æ–­ã€‚
5. HTTP API ä¸Žç«¯åˆ°ç«¯é›†æˆæµ‹è¯•ã€‚
6. JWT é‰´æƒæŽ¥å…¥ã€‚
7. æŒä¹…åŒ–å­˜å‚¨ï¼ˆ`data/db.json`ï¼‰ä¸Žé‡å¯æ¢å¤ã€‚
8. WebSocket å®žæ—¶æŽ¨é€ä¸Žåœ¨çº¿è¿žæŽ¥æ•°ç›‘æµ‹æŽ¥å£ã€‚
9. ç»†é¢—ç²’è§’è‰²æƒé™æŽ§åˆ¶ï¼ˆCustomer/Clerk/Manager/Ownerï¼‰ã€‚
10. å…±äº«åº“å¼ºéš”ç¦»ï¼šç”¨æˆ·ä¸Žæ”¯ä»˜æ•°æ®æŒ‰å•†æˆ·åˆ†æ¡¶ï¼Œå…³é”®è·¯å¾„æ ¡éªŒç§Ÿæˆ·è¾¹ç•Œã€‚
11. ç§Ÿæˆ·è·¯ç”±å±‚ï¼ˆ`TenantRouter`ï¼‰ï¼šæ”¯æŒçƒ­ç‚¹å•†æˆ·æŒ‚è½½ç‹¬ç«‹æ•°æ®æºã€‚
12. å®¡è®¡æ—¥å¿—ï¼ˆ`auditLogs`ï¼‰ï¼šæ”¯ä»˜ã€é€€æ¬¾ã€ææ¡ˆç¡®è®¤ã€ç†”æ–­ã€TCA è§¦å‘å‡å¯è¿½æº¯ã€‚
13. å®¡è®¡æ—¥å¿—æŸ¥è¯¢æŽ¥å£ï¼ˆ`/api/audit/logs`ï¼‰ï¼šæ”¯æŒæŒ‰å•†æˆ·ã€æ—¶é—´çª—ã€åŠ¨ä½œã€ç»“æžœåˆ†é¡µæŸ¥è¯¢ã€‚
14. åœ¨çº¿çŠ¶æ€æŽ¥å£ï¼ˆ`/api/ws/status`ï¼‰ï¼šå·²å¯ç”¨å•†æˆ· scope å¼ºæ ¡éªŒï¼Œè·¨å•†æˆ·æŸ¥è¯¢è¿”å›ž `merchant scope denied`ã€‚
15. ç§Ÿæˆ·ç­–ç•¥ç®¡ç†ï¼ˆ`tenantPolicy`ï¼‰ï¼šæ”¯æŒå•†æˆ·å†™å†»ç»“ã€å®žæ—¶é€šé“å¼€å…³ã€æŒ‰æ“ä½œé™æµï¼ˆé…é¢æ²»ç†åŸºç¡€èƒ½åŠ›ï¼‰ã€‚
16. ç§Ÿæˆ·ç­–ç•¥ç®¡ç† APIï¼ˆ`/api/merchant/tenant-policy`ï¼‰ï¼šæ”¯æŒ Owner åœ¨çº¿æŸ¥è¯¢/æ›´æ–°ç­–ç•¥å¹¶å†™å®¡è®¡æ—¥å¿—ã€‚
17. ç§Ÿæˆ·ç­–ç•¥æŒä¹…åŒ–ï¼š`tenantPolicies` çº³å…¥å¿«ç…§ï¼Œé‡å¯åŽè‡ªåŠ¨æ¢å¤ã€‚
18. è¿ç§»ç¼–æŽ’ APIï¼ˆ`/api/merchant/migration/*`ï¼‰ï¼šæ”¯æŒ Owner æŸ¥è¯¢çŠ¶æ€å¹¶æ‰§è¡Œå†»ç»“/è§£å†»æ­¥éª¤ã€‚
19. è‡ªåŠ¨åˆ‡åº“èƒ½åŠ›ï¼š`/api/merchant/migration/cutover` å¯åœ¨çº¿åˆ‡æ¢å•†æˆ·åˆ°ä¸“åº“å¹¶æŒä¹…åŒ–è·¯ç”±ã€‚
20. è‡ªåŠ¨å›žæ»šèƒ½åŠ›ï¼š`/api/merchant/migration/rollback` å¯åœ¨çº¿å›žæµå…±äº«åº“å¹¶æ¸…ç†ä¸“åº“è·¯ç”±ç»‘å®šã€‚
21. å¤–éƒ¨æ”¯ä»˜å›žè°ƒé“¾è·¯ï¼š`/api/payment/callback` å·²æŽ¥å…¥ HMAC éªŒç­¾ä¸Žå¼‚æ­¥å…¥è´¦ã€‚
22. å‘ç¥¨åŠ©æ‰‹ï¼š`/api/invoice/*` å·²æ”¯æŒå¼€ç¥¨ä¸ŽæŸ¥è¯¢ã€‚
23. éšç§åˆè§„æŽ¥å£ï¼š`/api/privacy/*` å·²æ”¯æŒå¯¼å‡ºä¸ŽåŒ¿ååŒ–åˆ é™¤ã€‚
24. æŒ‡æ ‡æŽ¥å£ï¼š`/metrics` å·²å¯ä¾› Prometheus æŠ“å–ã€‚
25. é¡¾å®¢è´¦åŠ¡æŸ¥è¯¢æŽ¥å£ï¼š`/api/payment/ledger` ä¸Žé¡¾å®¢å¯è¯» `/api/invoice/list` å·²ä¸Šçº¿å¹¶å®Œæˆ scope é˜²æŠ¤ã€‚

åŽç»­ï¼ˆä¿æŒæ€»è§„èŒƒä¸€è‡´ï¼‰ï¼š
1. å†…å­˜ä»“å‚¨æ›¿æ¢ä¸ºæŒä¹…åŒ–æ•°æ®åº“ã€‚
2. ç‰©ç†åˆ†åº“ä¸Žç§Ÿæˆ·è·¯ç”±ï¼ˆçƒ­ç‚¹å•†æˆ·ç‹¬ç«‹åº“ï¼‰åŠé…é¢æ²»ç†èƒ½åŠ›ã€‚
3. æŽ¥å…¥çœŸå®žæ”¯ä»˜ç½‘å…³ä¸Žå¼‚æ­¥å›žè°ƒç­¾åæ ¡éªŒé“¾è·¯ã€‚

---

## 11. å¤šç§Ÿæˆ·è§„æ¨¡åŒ–æ¼”è¿›ç­–ç•¥ï¼ˆå¯¹åº” 10 ä¸‡ç”¨æˆ· / åƒåº—é‡çº§ï¼‰

é˜¶æ®µ Aï¼šå…±äº«åº“å¼ºéš”ç¦»ï¼ˆå½“å‰ï¼‰
1. æ•°æ®æŒ‰å•†æˆ·åˆ†æ¡¶ï¼ˆ`merchantUsers/paymentsByMerchant`ï¼‰ï¼Œæ‰€æœ‰è¯»å†™å¼ºåˆ¶æ ¡éªŒ `merchantId` scopeã€‚
2. é€‚ç”¨ï¼šå•†æˆ·æ•°é‡å¢žé•¿ä½†çƒ­ç‚¹ä¸æ˜Žæ˜¾ï¼Œä¼˜å…ˆé™ä½Žç³»ç»Ÿå¤æ‚åº¦ä¸Žè¿ç»´æˆæœ¬ã€‚
3. é…é¢æ²»ç†ï¼šé€šè¿‡ `tenantPolicy` å¯¹å•†æˆ·å¯ç”¨å†™å†»ç»“ä¸ŽæŒ‰æ“ä½œé™æµï¼ˆ`PAYMENT_VERIFY/REFUND/TCA...`ï¼‰ã€‚

é˜¶æ®µ Bï¼šçƒ­ç‚¹å•†æˆ·ç‰©ç†åˆ†åº“ï¼ˆä¸‹ä¸€æ­¥ï¼‰
1. ä¿æŒç»Ÿä¸€ API ä¸Žç§Ÿæˆ·è·¯ç”±å±‚ï¼Œä»…å°†çƒ­ç‚¹å•†æˆ·è¿ç§»åˆ°ä¸“å±žæ•°æ®æºã€‚
2. è¿ç§»åŽŸåˆ™ï¼šå•å•†æˆ· QPS/å­˜å‚¨/å¤§è¡¨å¢žé•¿æŒç»­é«˜äºŽé˜ˆå€¼ï¼Œä¸”å½±å“å…±äº«åº“ç¨³å®šæ€§ã€‚
3. å›žé€€èƒ½åŠ›ï¼šè·¯ç”±å¯å¿«é€Ÿåˆ‡å›žå…±äº«åº“ï¼Œé¿å…ä¸€æ¬¡æ€§å…¨é‡åˆ†åº“å¸¦æ¥çš„é«˜é£Žé™©ã€‚
4. è¿ç§»æœŸé—´å¯ç»“åˆ `tenantPolicy.writeEnabled=false` è¿›å…¥å•†æˆ·è¯»å†™å†»ç»“çª—å£ï¼Œå®Œæˆæ•°æ®æ¬è¿åŽå†æ¢å¤å†™æµé‡ã€‚

ä¸ºä½•ä¸ä¸€æ¬¡åˆ°ä½å…¨é‡åˆ†åº“
1. ç»å¤§å¤šæ•°å•†æˆ·åœ¨æ—©æœŸæ˜¯é•¿å°¾è´Ÿè½½ï¼Œå…¨é‡åˆ†åº“ä¼šå¸¦æ¥è¿‡é«˜è¿ç»´ä¸Žæ•°æ®æ²»ç†æˆæœ¬ã€‚
2. å…±äº«åº“é˜¶æ®µæ›´åˆ©äºŽå¿«é€Ÿè¿­ä»£ä¸šåŠ¡è§„åˆ™ä¸Žå®¡è®¡æ¨¡åž‹ï¼Œé™ä½Žæž¶æž„å†»ç»“é£Žé™©ã€‚
3. çƒ­ç‚¹ä¼˜å…ˆåˆ†åº“å¯åœ¨æ”¶ç›Šæœ€å¤§å¤„ä¼˜å…ˆæ¶ˆé™¤ç“¶é¢ˆï¼ŒæŠ•å…¥äº§å‡ºæ¯”æ›´é«˜ã€‚

